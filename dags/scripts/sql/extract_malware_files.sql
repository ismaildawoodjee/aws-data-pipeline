-- this code updates the database with new week's data, only on Mondays (DayOfWeek = 1)
COPY threats.malware_file
FROM
    '/source-data/dated_malware_detection.csv' CSV DELIMITER ',' HEADER
WHERE
    EXTRACT(
        DOW
        FROM
            CURRENT_DATE
    ) = 1;

-- the following code pulls out yesterday's batch today, at midnight UTC
COPY (
    SELECT
        time_received,
        download_source,
        top_level_domain,
        download_speed,
        ping_time_to_server,
        file_size_bytes,
        how_many_times_file_seen,
        executable_code_maybe_present_in_headers,
        calls_to_low_level_system_libraries,
        evidence_of_code_obfuscation,
        threads_started,
        mean_word_length_of_extracted_strings,
        similarity_score,
        characters_in_url,
        actually_malicious,
        initial_statistical_analysis
    FROM
        threats.malware_file
    WHERE
        time_received < CURRENT_DATE
        AND time_received >= CURRENT_DATE - 1
    ORDER BY
        time_received ASC
) TO '{{ params.malware_files }}' WITH (FORMAT CSV, HEADER);